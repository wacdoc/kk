# Өзіңіздің SMTP пошта жіберу серверіңізді жасаңыз

## преамбула

SMTP бұлтты жеткізушілерден қызметтерді тікелей сатып ала алады, мысалы:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Ali бұлтты электрондық поштаны басу](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Сондай-ақ, сіз өзіңіздің пошта серверіңізді құра аласыз - шексіз жіберу, жалпы құны төмен.

Төменде біз өз пошта серверімізді қалай құру керектігін кезең-кезеңімен көрсетеміз.

## Серверді таңдау

Өздігінен орналастырылған SMTP сервері 25, 456 және 587 порттары ашық жалпыға ортақ IP мекенжайын қажет етеді.

Жиі қолданылатын жалпы бұлттар бұл порттарды әдепкі бойынша бұғаттады және оларды жұмысқа тапсырыс беру арқылы ашуға болады, бірақ бұл өте қиын.

Мен осы порттары ашық және кері домен атауларын орнатуды қолдайтын хосттан сатып алуды ұсынамын.

Мұнда мен [Contabo](https://contabo.com) ұсынамын.

Contabo - 2003 жылы негізі қаланған, өте бәсекеге қабілетті бағамен Германияның Мюнхен қаласында орналасқан хостинг провайдері.

Сатып алу валютасы ретінде еуро таңдасаңыз, баға арзанырақ болады (8 ГБ жады мен 4 процессоры бар сервер жылына шамамен 529 юань тұрады, ал бастапқы орнату ақысы бір жыл бойы тегін).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Тапсырыс беру кезінде `prefer AMD` ескертіңіз және AMD процессоры бар сервер жақсырақ өнімділікке ие болады.

Төменде мен өзіңіздің пошта серверіңізді құру жолын көрсету үшін мысал ретінде Contabo-ның VPS-ін аламын.

## Ubuntu жүйесінің конфигурациясы

Мұндағы амалдық жүйе Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Егер ssh серверінде `Welcome to TinyCore 13!` (төмендегі суретте көрсетілгендей), бұл жүйе әлі орнатылмағанын білдіреді. Жүйеге қайта кіру үшін ssh ажыратып, бірнеше минут күтіңіз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

`Welcome to Ubuntu 22.04.1 LTS` пайда болғанда, инициализация аяқталды және келесі қадамдарды жалғастыра аласыз.

### [Қосымша] Әзірлеу ортасын инициализациялаңыз

Бұл қадам міндетті емес.

Ыңғайлы болу үшін [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) сайтында ubuntu бағдарламалық құралын орнатуды және жүйелік конфигурацияны қойдым.

Бір рет басу арқылы орнату үшін келесі пәрменді іске қосыңыз.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Қытай пайдаланушылары, оның орнына келесі пәрменді пайдаланыңыз, сонда тіл, уақыт белдеуі және т.б. автоматты түрде орнатылады.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo IPV6 мүмкіндігін қосады

SMTP де IPV6 мекенжайлары бар электрондық хаттарды жібере алатындай IPV6 қосыңыз.

өңдеу `/etc/sysctl.conf`

Келесі жолдарды өзгертіңіз немесе қосыңыз

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

[Контабо оқулығын орындаңыз: серверге IPv6 қосылымын қосу](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

`/etc/netplan/01-netcfg.yaml` өңдеңіз, төмендегі суретте көрсетілгендей бірнеше жолды қосыңыз (Contabo VPS әдепкі конфигурация файлында бұл жолдар бар, жай ғана оларға түсініктеме беріңіз).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Содан кейін өзгертілген конфигурация күшіне енуі үшін `netplan apply` .

Конфигурация сәтті аяқталғаннан кейін сыртқы желінің ipv6 мекенжайын көру үшін `curl 6.ipw.cn` пайдалануға болады.

## Конфигурация репозиторий операцияларын клондау

```
git clone https://github.com/wactax/ops.soft.git
```

## Домендік атыңыз үшін тегін SSL сертификатын жасаңыз

Поштаны жіберу шифрлау және қол қою үшін SSL сертификатын қажет етеді.

Біз сертификаттарды жасау үшін [acme.sh](https://github.com/acmesh-official/acme.sh) пайдаланамыз.

acme.sh – ашық бастапқы автоматтандырылған сертификатқа қол қою құралы,

ops.soft конфигурация қоймасын енгізіңіз, `./ssl.sh` іске қосыңыз және **жоғарғы каталогта** `conf` қалтасы жасалады.

[Acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) сайтынан DNS провайдерін табыңыз, `conf/conf.sh` өңдеңіз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Содан кейін домен атыңыз үшін `123.com` және `*.123.com` сертификаттарын жасау үшін `./ssl.sh 123.com` іске қосыңыз.

Бірінші іске қосу [acme.sh бағдарламасын](https://github.com/acmesh-official/acme.sh) автоматты түрде орнатады және автоматты жаңарту үшін жоспарланған тапсырманы қосады. Сіз `crontab -l` көре аласыз, келесідей жол бар.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Жасалған сертификаттың жолы `/mnt/www/.acme.sh/123.com_ecc。`

Куәлікті жаңарту `conf/reload/123.com.sh` сценарийін шақырады, осы сценарийді өңдеңіз, қатысты қолданбалардың сертификат кэшін жаңарту үшін `nginx -s reload` сияқты пәрмендерді қосуға болады.

## Chasquid көмегімен SMTP серверін құрастырыңыз

[chasquid](https://github.com/albertito/chasquid) – Go тілінде жазылған ашық бастапқы SMTP сервері.

Postfix және Sendmail сияқты ежелгі пошта серверінің бағдарламаларын алмастыратын chasquid қарапайым және пайдалану оңайырақ, сонымен қатар оны қайталама әзірлеуге оңайырақ.

`./chasquid/init.sh 123.com` бір рет басу арқылы автоматты түрде орнатылады (123.com дегенді жіберуші домендік атаумен ауыстырыңыз).

## DKIM электрондық пошта қолтаңбасын конфигурациялау

DKIM хаттардың спам ретінде қарастырылуын болдырмау үшін электрондық пошта қолтаңбаларын жіберу үшін пайдаланылады.

Пәрмен сәтті орындалған соң, сізге DKIM жазбасын орнату ұсынылады (төменде көрсетілгендей).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Тек DNS жүйесіне TXT жазбасын қосыңыз (төменде көрсетілгендей).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Қызмет күйін және журналдарды көру

 `systemctl status chasquid` Қызмет күйін көру.

Қалыпты жұмыс күйі төмендегі суретте көрсетілгендей

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` немесе `journalctl -xeu chasquid` қате журналын көре алады.

## Кері домен атауының конфигурациясы

Кері домендік атау IP мекенжайын сәйкес домендік атаумен шешуге мүмкіндік береді.

Кері домен атауын орнату электрондық пошталардың спам ретінде анықталуына жол бермейді.

Пошта қабылданған кезде, қабылдаушы сервер жіберуші серверде жарамды кері домен атауы бар-жоғын растау үшін жіберуші сервердің IP мекенжайында кері домендік атауды талдауды орындайды.

Жіберуші серверде кері домен атауы болмаса немесе кері домендік атау жіберуші сервердің IP мекенжайына сәйкес келмесе, қабылдаушы сервер электрондық поштаны спам деп тануы немесе оны қабылдамауы мүмкін.

[https://my.contabo.com/rdns](https://my.contabo.com/rdns) сайтына кіріп, төменде көрсетілгендей конфигурациялаңыз

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Кері домен атауын орнатқаннан кейін, IPv4 және ipv6 домендік атауының серверге бағыттау ажыратымдылығын конфигурациялауды ұмытпаңыз.

## chasquid.conf хост атауын өңдеңіз

`conf/chasquid/chasquid.conf` кері домен атауының мәніне өзгертіңіз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Содан кейін қызметті қайта іске қосу үшін `systemctl restart chasquid` іске қосыңыз.

## git репозиторийіне сақтық көшірме жасау

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Мысалы, мен conf қалтасының сақтық көшірмесін өзімнің github процесіне төмендегідей жасаймын

Алдымен жеке қойма жасаңыз

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

conf каталогын енгізіп, қоймаға жіберіңіз

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Жіберушіні қосыңыз

жүгіру

```
chasquid-util user-add i@wac.tax
```

Жіберушіні қосуға болады

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Құпия сөздің дұрыс орнатылғанын тексеріңіз

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Пайдаланушыны қосқаннан кейін `chasquid/domains/wac.tax/users` жаңартылады, оны қоймаға жіберуді ұмытпаңыз.

## DNS SPF жазбасын қосады

SPF ( Sender Policy Framework ) электрондық пошта алаяқтығын болдырмау үшін пайдаланылатын электрондық поштаны тексеру технологиясы.

Ол жіберушінің IP мекенжайы ол мәлімдеген домен атауының DNS жазбаларына сәйкес келетінін тексеру арқылы пошта жіберушінің жеке басын тексеріп, алаяқтардың жалған электрондық хаттарды жіберуіне жол бермейді.

SPF жазбаларын қосу электрондық пошталардың спам ретінде анықталуының мүмкіндігінше алдын алады.

Домендік атау серверіңіз SPF түрін қолдамаса, TXT түріндегі жазбаны қосыңыз.

Мысалы, `wac.tax` SPF келесідей

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

`_spf.wac.tax` үшін SPF

`v=spf1 a:smtp.wac.tax ~all`

Мұнда менде `include:_spf.google.com` , себебі мен `i@wac.tax` мекенжайын Google пошта жәшігіндегі жіберу мекенжайы ретінде кейінірек конфигурациялаймын.

## DNS конфигурациясы DMARC

DMARC (Domain-based Message Authentication, Reporting & Conformance) аббревиатурасы.

Ол SPF серпілістерін түсіру үшін қолданылады (мүмкін конфигурация қателерінен туындауы мүмкін немесе басқа біреу спам жіберу үшін сіз болып көрінуі мүмкін).

TXT жазбасын қосыңыз `_dmarc` ,

Мазмұны келесідей

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Әрбір параметрдің мәні келесідей

### p (саясат)

SPF (Sender Policy Framework) немесе DKIM (DomainKeys Identified Mail) тексеруінен өтпеген электрондық пошталарды өңдеу жолын көрсетеді. p параметрін үш мәннің біріне орнатуға болады:

* ешқайсысы: Ешқандай әрекет жасалмайды, тек тексеру нәтижесі электрондық пошта хабарлау механизмі арқылы жіберушіге қайтарылады.
* Карантин: Тексеруден өтпеген хатты спам қалтасына салыңыз, бірақ хатты тікелей қабылдамайды.
* қабылдамау: растау орындалмаған электрондық пошталарды тікелей қабылдамау.

### fo (сәтсіздік опциялары)

Есеп беру механизмі қайтаратын ақпарат көлемін көрсетеді. Оны келесі мәндердің біріне орнатуға болады:

* 0: барлық хабарлар үшін тексеру нәтижелерін хабарлау
* 1: Тексеруден өтпеген хабарларды ғана хабарлаңыз
* d: тек домен атауын тексеру қателері туралы хабарлау
* s: тек SPF тексеру қателері туралы хабарлау
* l: DKIM тексеру қателері туралы ғана хабарлаңыз

### rua & ruf

* rua (Жиынтық есептер үшін есеп беру URI): Жиынтық есептерді алуға арналған электрондық пошта мекенжайы
* ruf (Сот сараптамасы есептері үшін есеп беру URI): егжей-тегжейлі есептерді алу үшін электрондық пошта мекенжайы

## Электрондық хаттарды Google Mail қызметіне жіберу үшін MX жазбаларын қосыңыз

Мен әмбебап мекенжайларды қолдайтын тегін корпоративтік пошта жәшігін таба алмағандықтан (Catch-All, осы домендік атқа жіберілген кез келген электрондық хаттарды префикстерге шектеусіз қабылдай алады), барлық электрондық хаттарды Gmail пошта жәшігіме жіберу үшін chasquid қолданбасын пайдаландым.

**Жеке ақылы бизнес пошта жәшігіңіз болса, MX өзгертпеңіз және бұл қадамды өткізіп жіберіңіз.**

`conf/chasquid/domains/wac.tax/aliases` өңдеу, қайта жіберу пошта жәшігін орнату

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` барлық электрондық пошталарды көрсетеді, `i` жоғарыда жасалған жіберуші пайдаланушының электрондық пошта мекенжайының префиксі. Поштаны қайта жіберу үшін әрбір пайдаланушы жолды қосуы керек.

Содан кейін MX жазбасын қосыңыз (төмендегі суреттегі бірінші жолда көрсетілгендей, кері домен атауының мекенжайын тікелей көрсетемін).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Конфигурация аяқталғаннан кейін, Gmail поштасында электрондық хаттарды ала алатыныңызды білу үшін `i@wac.tax` және `any123@wac.tax` мекенжайларына электрондық хаттарды жіберу үшін басқа электрондық пошта мекенжайларын пайдалануға болады.

Олай болмаса, chasquid журналын тексеріңіз ( `grep chasquid /var/log/syslog` ).

## Google Mail арқылы i@wac.tax мекенжайына электрондық хат жіберіңіз

Google Mail поштаны алғаннан кейін, мен әрине i.wac.tax@gmail.com орнына `i@wac.tax` арқылы жауап беремін деп үміттендім.

[https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) сайтына кіріп, "Басқа электрондық пошта мекенжайын қосу" түймесін басыңыз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Содан кейін, жіберілген электрондық пошта арқылы алынған растау кодын енгізіңіз.

Соңында, оны жіберушінің әдепкі мекенжайы ретінде орнатуға болады (сол мекенжаймен жауап беру опциясымен бірге).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Осылайша, біз SMTP пошта серверін құруды аяқтадық және сонымен бірге электрондық поштаны жіберу және алу үшін Google Mail қызметін қолданамыз.

## Конфигурацияның сәтті болғанын тексеру үшін сынақ электрондық поштасын жіберіңіз

`ops/chasquid` енгізіңіз

Тәуелділіктерді орнатуға `direnv allow` іске қосыңыз (direnv алдыңғы бір кілтті инициализация процесінде орнатылған және қабықшаға ілмек қосылған)

сосын жүгір

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Параметрлердің мағынасы келесідей

* пайдаланушы: SMTP пайдаланушы аты
* өту: SMTP құпия сөзі
* кімге: алушы

Сынақ электрондық поштасын жіберуге болады.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Конфигурациялардың сәтті болғанын тексеру үшін сынақ электрондық хаттарын алу үшін Gmail қызметін пайдалану ұсынылады.

### TLS стандартты шифрлауы

Төмендегі суретте көрсетілгендей, бұл шағын құлып бар, бұл SSL сертификатының сәтті қосылғанын білдіреді.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Содан кейін «Түпнұсқа электрондық поштаны көрсету» түймесін басыңыз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Төмендегі суретте көрсетілгендей, Gmail түпнұсқалық пошта бетінде DKIM көрсетіледі, бұл DKIM конфигурациясының сәтті екенін білдіреді.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Түпнұсқа электрондық поштаның тақырыбындағы «Қабылданды» параметрін тексеріңіз және жіберуші мекенжайы IPV6 екенін көре аласыз, яғни IPV6 да сәтті конфигурацияланған.
